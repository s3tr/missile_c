<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Missile Command — Fixed</title>
  <style>
    html,body{height:100%;margin:0;background:#000}
    :root{--bg1:#041026;--bg2:#00121a;--accent:#62d0ff;--hit:#ff8c42;--city:#d9e1b8;--base:#9be3a5;--glass:rgba(255,255,255,0.05)}
    body{font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:radial-gradient(1200px 600px at 10% 10%,rgba(80,120,160,.06),transparent),linear-gradient(180deg,var(--bg1),var(--bg2));color:#fff;overflow:hidden;display:flex;align-items:center;justify-content:center}
    #game{width:min(1100px,96vw);height:min(700px,86vh);position:relative;border-radius:14px;box-shadow:0 10px 40px rgba(0,0,0,.6), inset 0 1px 0 rgba(255,255,255,.03);overflow:hidden;background:linear-gradient(180deg,rgba(255,255,255,.02),transparent)}
    canvas{display:block;width:100%;height:100%;background:transparent}
    .hud{position:absolute;left:14px;top:12px;font-size:14px;backdrop-filter:blur(6px);padding:8px 10px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));box-shadow:0 6px 18px rgba(0,0,0,.5)}
    .hud .title{font-weight:700;letter-spacing:.6px}
    .controls{position:absolute;right:14px;top:12px;font-size:13px;padding:8px 10px;border-radius:10px;background:var(--glass)}
    .footer{position:absolute;left:50%;transform:translateX(-50%);bottom:12px;font-size:13px;padding:6px 12px;border-radius:10px;background:var(--glass)}
    button{background:linear-gradient(180deg,var(--accent),#2aa0d9);border:none;padding:8px 14px;border-radius:8px;cursor:pointer;color:#012;text-shadow:0 1px 0 rgba(255,255,255,.2);font-size:15px;font-weight:600}
    .muted{opacity:.9;color:#cfeaff}
    .menu,.overlay{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.7);z-index:10}
    .hidden{display:none}
    .menu h1,.overlay h1{margin-bottom:20px}
    @media (max-width:720px){.hud,.controls,.footer{font-size:12px;padding:6px}}
  </style>
</head>
<body>
<div id="game">
  <canvas id="c"></canvas>

  <div class="hud" id="hud">
    <div class="title">Missile Command — Vintage Remix</div>
    <div id="score">Score: 0</div>
    <div id="cities">Cities: 6</div>
    <div id="ammo">Ammo: 0 / 0 / 0</div>
  </div>

  <div class="controls muted">
    <div>Click / Tap: ateş et</div>
    <div style="margin-top:6px">R: yeniden başlat • Space: durdur</div>
  </div>

  <div class="footer muted" id="footer">Wave 1 — difficulty: normal</div>

  <div id="mainMenu" class="menu">
    <h1>Missile Command</h1>
    <button id="startBtn">Start Game</button>
  </div>

  <div id="gameOverScreen" class="overlay hidden">
    <h1>Game Over</h1>
    <div style="display:flex;gap:8px">
      <button id="restartBtn">Restart</button>
      <button id="menuBtn">Main Menu</button>
    </div>
  </div>
</div>

<script>
/* ===== Canvas & DPI ===== */
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let DPR=1, W=0, H=0;
function resize(){
  DPR = Math.min(window.devicePixelRatio||1, 2);
  const cssW = canvas.clientWidth, cssH = canvas.clientHeight;
  canvas.width  = Math.floor(cssW * DPR);
  canvas.height = Math.floor(cssH * DPR);
  W = canvas.width; H = canvas.height;
  ctx.setTransform(1,0,0,1,0,0); // draw in pixel space
}
window.addEventListener('resize', resize); resize();

/* ===== State ===== */
let score=0, wave=1, paused=false, gameOver=false, running=false;
let cities=[], bases=[], enemies=[], interceptors=[], explosions=[], particles=[];
let last = performance.now(), spawnAccum=0, spawnGap=2.5;

const mainMenu = document.getElementById('mainMenu');
const gameOverScreen = document.getElementById('gameOverScreen');
document.getElementById('startBtn').onclick = () => startGame();
document.getElementById('restartBtn').onclick = () => startGame();
document.getElementById('menuBtn').onclick = () => showMenu();

document.addEventListener('keydown', (e)=>{
  if(e.code === 'Space'){
    if(running && !gameOver){ paused = !paused; }
    e.preventDefault();
  }else if(e.key.toLowerCase()==='r'){
    startGame();
  }
});

/* ===== Helpers: normalized <-> pixel =====
   Tüm oyun mantığı 0..1 normalize koordinatlarda.
   Çizim yaparken px'e çeviriyoruz. */
const NX = x => x * W;
const NY = y => y * H;

/* ===== Init ===== */
function init(){
  score=0; wave=1; paused=false; gameOver=false;
  enemies.length=0; interceptors.length=0; explosions.length=0; particles.length=0;
  cities.length=0; bases.length=0;
  spawnAccum=0; spawnGap=2.5;

  const groundY = 0.85; // altta yer kaplaması için yüksek tuttuk
  const cityCount = 6;
  for(let i=0;i<cityCount;i++){
    cities.push({ x: 0.12 + i*(0.76/(cityCount-1)), y: groundY, alive:true });
  }
  // 3 batarya: sol-orta-sağ
  bases.push({ x: 0.10, y: groundY+0.02, ammoMax:20, ammo:20 });
  bases.push({ x: 0.50, y: groundY+0.02, ammoMax:20, ammo:20 });
  bases.push({ x: 0.90, y: groundY+0.02, ammoMax:20, ammo:20 });

  updateHUD();
}

/* ===== UI ===== */
const scoreEl = document.getElementById('score');
const citiesEl = document.getElementById('cities');
const ammoEl = document.getElementById('ammo');
const footerEl = document.getElementById('footer');

function updateHUD(){
  scoreEl.textContent = 'Score: ' + score;
  citiesEl.textContent = 'Cities: ' + cities.filter(c=>c.alive).length;
  ammoEl.textContent = 'Ammo: ' + bases.map(b=>b.ammo).join(' / ');
  footerEl.textContent = 'Wave ' + wave + ' — difficulty: ' + (wave<5?'easy':wave<10?'normal':wave<16?'hard':'insane');
}

function startGame(){
  mainMenu.classList.add('hidden');
  gameOverScreen.classList.add('hidden');
  init();
  running = true;
  last = performance.now();
  requestAnimationFrame(loop);
}

function showMenu(){
  running=false;
  mainMenu.classList.remove('hidden');
  gameOverScreen.classList.add('hidden');
}

/* ===== Input: ateş et ===== */
canvas.addEventListener('pointerdown', (e)=>{
  // Overlay açıkken canvas tıklaması ateş etmesin
  if(!running || gameOver || paused) return;

  const rect = canvas.getBoundingClientRect();
  const tx = (e.clientX - rect.left) / rect.width;
  const ty = (e.clientY - rect.top)  / rect.height;

  fireInterceptor(tx, ty);
});

function fireInterceptor(tx, ty){
  // En yakın, cephanesi olan bataryayı bul
  let best=null, bestD=Infinity;
  for(const b of bases){
    if(b.ammo>0){
      const d = Math.abs(b.x - tx);
      if(d < bestD){ best=b; bestD=d; }
    }
  }
  if(!best) return;
  best.ammo--;
  interceptors.push({
    x: best.x, y: best.y,
    tx, ty,
    t: 0, spd: 1.1  // 0..1 arasında ilerleme
  });
  // namlu efekti
  for(let i=0;i<10;i++){
    particles.push({x:best.x,y:best.y,vx:(Math.random()-.5)*0.03,vy:-Math.random()*0.05,life:0.3+Math.random()*0.3,size:1+Math.random()*1.5,color:'#9be3a5'});
  }
  updateHUD();
}

/* ===== Oyun Döngüsü ===== */
function loop(now){
  if(!running) return;
  const dt = Math.min((now - last)/1000, 0.033);
  last = now;

  if(!paused){
    update(dt);
  }
  render();

  requestAnimationFrame(loop);
}

/* ===== Spawn / Update ===== */
function update(dt){
  // düşman spawn
  spawnAccum += dt;
  const targetGap = Math.max(2.2 - wave*0.12, 0.7); // dalga ilerledikçe hızlansın ama saçmalamasın
  if(spawnAccum >= spawnGap){
    spawnWave();
    spawnAccum = 0;
    spawnGap = targetGap;
    wave++;
  }

  // düşman füzeler
  for(let i=enemies.length-1;i>=0;i--){
    const m = enemies[i];
    const dx = m.tx - m.x, dy = m.ty - m.y;
    const dist = Math.hypot(dx,dy) || 1e-6;
    const step = (m.speed * dt) / dist;
    m.x += dx * step;
    m.y += dy * step;

    // hedefe çarptı mı?
    if(Math.hypot(m.x - m.tx, m.y - m.ty) < 0.01){
      // şehre ya da bataryaya hasar
